/*******************************************************************************
 * Copyright 2016 Fredhopper B.V.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *******************************************************************************/
package com.fredhopper.core.connector.query.service;

import static org.mockserver.model.HttpRequest.request;
import static org.mockserver.model.HttpResponse.response;

import javax.xml.ws.WebServiceException;

import org.junit.Rule;
import org.junit.Test;
import org.mockserver.client.server.MockServerClient;
import org.mockserver.junit.MockServerRule;
import org.mockserver.matchers.Times;
import org.mockserver.model.Header;
import org.mockserver.model.StringBody;

import com.fredhopper.lang.query.Query;
import com.fredhopper.webservice.client.Breadcrumbs;
import com.fredhopper.webservice.client.FASWebService;
import com.fredhopper.webservice.client.Page;
import com.fredhopper.webservice.client.Universe;
import com.fredhopper.webservice.client.UniverseType;


/**
 *
 */
public class FhQueryServiceTest
{

	@Rule
	public MockServerRule mockServerRule = new MockServerRule(this, 1080);

	private final MockServerClient client = new MockServerClient("localhost", 1080);

	protected FASWebService getFasWebservice()
	{
		final DefaultFasWebserviceFactory fasWebserviceFactory = new DefaultFasWebserviceFactory();

		fasWebserviceFactory.setServicePassword("your_password");
		fasWebserviceFactory.setServiceUsername("example5");
		fasWebserviceFactory.setServiceUrl("http://localhost:1080/fredhopper-ws/services/FASWebService");
		return fasWebserviceFactory.getObject();
	}

	protected void setNegativeAnswer(final MockServerClient client)
	{
		client.when(
				request().withMethod("POST").withPath("/fredhopper-ws/services/FASWebService")
						.withHeaders(new Header("Accept", "text/xml, multipart/related"),
								new Header("Authorization", "Basic ZXhhbXBsZTU6eW91cl9wYXNzd29yZA=="),
								new Header("Content-Type", "text/xml; charset=utf-8"), new Header("Content-Length", "218"))
				.withSecure(false).withKeepAlive(true)
				.withBody(new StringBody(
						"<?xml version=\"1.0\" ?><S:Envelope xmlns:S=\"http://schemas.xmlsoap.org/soap/envelope/\"><S:Body><fh_params xmlns=\"http://ns.fredhopper.com/XML/output/6.1.0\">fh_location=//catalog01/en_GB</fh_params></S:Body></S:Envelope>")),
				Times.once()).respond(response().withStatusCode(500));
	}

	protected void setPositiveAnswer(final MockServerClient client)
	{
		client.when(
				request().withMethod("POST").withPath("/fredhopper-ws/services/FASWebService")
						.withHeaders(new Header("Accept", "text/xml, multipart/related"),
								new Header("Authorization", "Basic ZXhhbXBsZTU6eW91cl9wYXNzd29yZA=="),
								new Header("Content-Type", "text/xml; charset=utf-8"),
								//new Header("SOAPAction", """"),
								// new Header("User-Agent", "JAX-WS RI 2.2.9-b130926.1035 svn-revision#5f6196f2b90e9460065a4c2f4e30e065b245e51e"),
								//   new Header("Host", "query.published.live1.fas.eu1.fredhopperservices.com"),
								new Header("Content-Length", "218"))
						.withSecure(false).withKeepAlive(true)
						.withBody(new StringBody(
								"<?xml version=\"1.0\" ?><S:Envelope xmlns:S=\"http://schemas.xmlsoap.org/soap/envelope/\"><S:Body><fh_params xmlns=\"http://ns.fredhopper.com/XML/output/6.1.0\">fh_location=//catalog01/en_GB</fh_params></S:Body></S:Envelope>")),
				Times.once())
				.respond(response().withStatusCode(200)
						.withHeaders(new Header("Server", "Apache-Coyote/1.1"), new Header("Connection", "keep-alive"),
								new Header("Vary", "Accept-Encoding"), new Header("Content-Length", "25079"),
								new Header("Date", "Thu, 22 Sep 2016 12:10:37 GMT"), new Header("Content-Type", "text/xml;charset=UTF-8"))
						.withBody(
								"<?xml version=\"1.0\" encoding=\"UTF-8\"?><soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns=\"http://ns.fredhopper.com/XML/output/6.1.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><soapenv:Body><page xmlns='http://ns.fredhopper.com/XML/output/6.1.0' qid='1250'><info><session>unknown</session><user-type>unknown</user-type><lang>en</lang><country>GB</country><locale mlvalue='en_GB'>en_GB</locale><current-universe>catalog01</current-universe><view>lister</view><mode>user</mode><query>//catalog01/en_GB</query><path>/fredhopper/query</path><type>lister</type><query-string-httpencoded>fh_location=%2f%2fcatalog01%2fen_GB</query-string-httpencoded><ranges><query-ranges></query-ranges><implicit-ranges></implicit-ranges></ranges><url>/fredhopper/query.fh?fh_location=%2f%2fcatalog01%2fen_GB</url><source-xml>/fredhopper/query?fh_location=%2f%2fcatalog01%2fen_GB</source-xml><server><encoding-detect-string>\u00DF</encoding-detect-string><host>10.85.23.223</host><port>8181</port><context-root>/fredhopper</context-root><role>live</role><config-dir>/mnt/deployment-data/instances/live/config</config-dir><locales><locale mlvalue='de_DE'>de_DE</locale><locale selected='true' mlvalue='en_GB'>en_GB</locale></locales><default-universe>catalog01</default-universe></server></info><universes><universe name='catalog01related'><link><name>catalog01related</name><url-params>fh_location=%2f%2fcatalog01related%2fen_GB</url-params></link></universe><universe name='catalog01' type='selected'><link><name>catalog01</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params></link><facetmap universe=\"catalog01\"></facetmap><breadcrumbs nr-of-items-in-selection=\"233\"><crumb><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><name type=\"home\" value=\"home\">Home</name></crumb><crumb><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><name type=\"selected-universe\" value=\"catalog01\">catalog01</name></crumb><attribute-types></attribute-types></breadcrumbs> <items-section>\n  <results view_size=\"20\" view_set_size=\"5\" total_items=\"233\" start_index=\"0\" view_size_param=\"fh_view_size\" start_index_param=\"fh_start_index\" current_set=\"1\">\n   <url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=</url-params>\n<ranking><id></id><sort-fields></sort-fields></ranking>\n  </results>\n   <heading>\n<link><name>secondid</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>secondid</value></link><link><name>name</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>@name</value></link><link><name>Size</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>size</value></link><link><name>Style</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>style</value></link><link><name>v_description</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>@v_description</value></link><link><name>v_name</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>@v_name</value></link><link><name>v_summary</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>@v_summary</value></link><link><name>Categories</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>categories</value></link><link><name>code</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>code</value></link><link><name>Product EAN</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort_by=ean</url-params><value>ean</value></link><link><name>itemtype</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>itemtype</value></link><link><name>variant_size</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>@variant_size</value></link><link><name>variant_style</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB</url-params><value>@variant_style</value></link>   </heading>\n  <items>\n<item id=\"100124\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"100124\">100124</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Panorama Pants Women</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"beet_red\" >beet red</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_260000_260900\" >Pants women</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>S</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>beet red</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=100124&amp;fh_lister_pos=0&amp;fh_modification=</url-params></link></item><item id=\"100191\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"100191\">100191</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Beacon Jacket</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"glacier\" >glacier</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_190000_190100\" >Snow Jackets</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>L;;L;;M;;M;;S;;XL;;XL;;XXL;;XXL</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>glacier;;lime</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=100191&amp;fh_lister_pos=1&amp;fh_modification=</url-params></link></item><item id=\"100378\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"100378\">100378</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Machete 158 11/12</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"uni\" >uni</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_10000_10100\" >Freestyle+Freeride</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>158.0</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=100378&amp;fh_lister_pos=2&amp;fh_modification=</url-params></link></item><item id=\"100402\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"100402\">100402</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Seizure Bag</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"clay_court\" >clay court</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_160000_160700\" >Bags</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>Uni</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>clay court</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=100402&amp;fh_lister_pos=3&amp;fh_modification=</url-params></link></item><item id=\"100744\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"100744\">100744</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Ace Straight Pant Women</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"pool_green\" >pool green</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_200000_200300\" >Snow Pants women</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>L;;S</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>pool green</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=100744&amp;fh_lister_pos=4&amp;fh_modification=</url-params></link></item><item id=\"100746\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"100746\">100746</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Anzere Pant Women</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"floging_pink\" >floging pink</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_200000_200300\" >Snow Pants women</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>XS</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>floging pink</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=100746&amp;fh_lister_pos=5&amp;fh_modification=</url-params></link></item><item id=\"100988\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"100988\">100988</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Cascata Beanie</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"olympian_blue\" >olympian blue</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_220000_220500\" >Beanies</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>Uni;;Uni</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>olympian blue</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=100988&amp;fh_lister_pos=6&amp;fh_modification=</url-params></link></item><item id=\"101580\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"101580\">101580</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Tone 153 11/12</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"multi\" >multi</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_10000_10100\" >Freestyle+Freeride</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>153.0</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>multi</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=101580&amp;fh_lister_pos=7&amp;fh_modification=</url-params></link></item><item id=\"108295\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"108295\">108295</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Respect 164 11/12</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"uni\" >uni</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_10000_10100\" >Freestyle+Freeride</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>164.0;;168.0</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=108295&amp;fh_lister_pos=8&amp;fh_modification=</url-params></link></item><item id=\"110839\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"110839\">110839</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Team 153 11/12</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"uni\" >uni</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_10000_10100\" >Freestyle+Freeride</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>153.0</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=110839&amp;fh_lister_pos=9&amp;fh_modification=</url-params></link></item><item id=\"130663\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"130663\">130663</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>HD Hero2 Outdoor Edition</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"uni\" >uni</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_220000_222000\" >Videocamera</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>Uni</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=130663&amp;fh_lister_pos=10&amp;fh_modification=</url-params></link></item><item id=\"132871\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"132871\">132871</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Limited Jacket</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"deepest_black\" >deepest black</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_190000_190100\" >Snow Jackets</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>L;;L;;M;;M;;S;;S;;XL;;XL;;XXL;;XXL</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>deepest black;;summer green</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=132871&amp;fh_lister_pos=11&amp;fh_modification=</url-params></link></item><item id=\"92961\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"92961\">92961</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Spikes 44</value></attribute><attribute isnull=\"false\" name=\"size\" basetype=\"set\"><value non-ml=\"fourfour_zero\" >44.0</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_350000_351200\" >Skimboard</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>44.0</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=92961&amp;fh_lister_pos=12&amp;fh_modification=</url-params></link></item><item id=\"94172\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"94172\">94172</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Camper Beanie</value></attribute><attribute isnull=\"false\" name=\"size\" basetype=\"set\"><value non-ml=\"uni\" >Uni</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_220000_220500\" >Beanies</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>Uni</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>black</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=94172&amp;fh_lister_pos=13&amp;fh_modification=</url-params></link></item><item id=\"94374\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"94374\">94374</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Studio Pant</value></attribute><attribute isnull=\"false\" name=\"size\" basetype=\"set\"><value non-ml=\"s\" >S</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_190000_190300\" >Snow Pants</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>L;;L;;L;;M;;M;;M;;S;;XL;;XL</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>air;;blacktop;;ink;;safety orange</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=94374&amp;fh_lister_pos=14&amp;fh_modification=</url-params></link></item><item id=\"94382\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"94382\">94382</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Strut Pant Women</value></attribute><attribute isnull=\"false\" name=\"size\" basetype=\"set\"><value non-ml=\"m\" >M</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_200000_200300\" >Snow Pants women</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>L;;L;;M;;M;;M;;M;;S;;S;;S;;S;;XS</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>blacktop;;blue book;;fern;;ink;;nail</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=94382&amp;fh_lister_pos=15&amp;fh_modification=</url-params></link></item><item id=\"97199\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"97199\">97199</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Monkeywrench 157 11/12</value></attribute><attribute isnull=\"false\" name=\"size\" basetype=\"set\"><value non-ml=\"onefivefour_zero\" >154.0</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_10000_10100\" >Freestyle+Freeride</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>154.0;;157.0</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=97199&amp;fh_lister_pos=16&amp;fh_modification=</url-params></link></item><item id=\"97252\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"97252\">97252</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Twc Standard 156W 11/12</value></attribute><attribute isnull=\"false\" name=\"size\" basetype=\"set\"><value non-ml=\"onefivesix_zero\" >156.0</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_10000_10100\" >Freestyle+Freeride</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>156.0;;158.0</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=97252&amp;fh_lister_pos=17&amp;fh_modification=</url-params></link></item><item id=\"102153\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"102153\">102153</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>AC Trefoil Shop Bag white</value></attribute><attribute isnull=\"false\" name=\"size\" basetype=\"set\"><value non-ml=\"uni\" >Uni</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_370000_160400\" >Bags women</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>Uni</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=102153&amp;fh_lister_pos=18&amp;fh_modification=</url-params></link></item><item id=\"102277\"><attribute name=\"secondid\" basetype=\"text\" isnull=\"false\"><value non-ml=\"102277\">102277</value></attribute><attribute name=\"name\" basetype=\"asset\" isnull=\"false\"><value>Trace Helm</value></attribute><attribute isnull=\"false\" name=\"style\" basetype=\"set\"><value non-ml=\"black\" >black</value></attribute><attribute isnull=\"false\" name=\"categories\" basetype=\"cat\"><value non-ml=\"catalog01_categories_450000_450100\" >Helmets Snow</value></attribute><attribute name=\"variant_size\" basetype=\"asset\" isnull=\"false\"><value>L;;L;;L;;L;;M;;M;;M;;M;;M;;M;;M;;S;;S;;S;;S;;XL;;XL;;XL;;XL</value></attribute><attribute name=\"variant_style\" basetype=\"asset\" isnull=\"false\"><value>black;;black matte;;green;;lime;;plaid print;;radical;;trench green;;white;;white pearl</value></attribute><link type='detail'><name>Detail</name><url-params>fh_location=%2f%2fcatalog01%2fen_GB&amp;fh_sort=&amp;fh_refview=lister&amp;fh_secondid=102277&amp;fh_lister_pos=19&amp;fh_modification=</url-params></link></item>  </items>\n </items-section>\n<themes><attribute-types><attribute-type name='secondid' type='text'>secondid</attribute-type><attribute-type name='@name' type='asset'>name</attribute-type><attribute-type name='brand' type='set'>brand</attribute-type><attribute-type name='price' type='unknown'>price</attribute-type><attribute-type name='_imageurl' type='unknown'>_imageurl</attribute-type></attribute-types></themes><display-fields><field reverse=\"false\" skey=\"secondid\" name=\"secondid\" basetype=\"text\"/><field reverse=\"false\" skey=\"@name\" name=\"name\" basetype=\"asset\"/><field reverse=\"false\" skey=\"catalog01related:size(ean)\" name=\"Size\" basetype=\"set\" ref-universe=\"catalog01related\" selection-criteria=\"ean\"/><field reverse=\"false\" skey=\"catalog01related:style(ean)\" name=\"Style\" basetype=\"set\" ref-universe=\"catalog01related\" selection-criteria=\"ean\"/><field reverse=\"false\" skey=\"catalog01related:@v_description(ean)\" name=\"v_description\" basetype=\"asset\" ref-universe=\"catalog01related\" selection-criteria=\"ean\"/><field reverse=\"false\" skey=\"catalog01related:@v_name(ean)\" name=\"v_name\" basetype=\"asset\" ref-universe=\"catalog01related\" selection-criteria=\"ean\"/><field reverse=\"false\" skey=\"catalog01related:@v_summary(ean)\" name=\"v_summary\" basetype=\"asset\" ref-universe=\"catalog01related\" selection-criteria=\"ean\"/><field reverse=\"false\" skey=\"categories\" name=\"Categories\" basetype=\"cat\"/><field reverse=\"false\" skey=\"code\" name=\"code\" basetype=\"unknown\"/><field reverse=\"false\" skey=\"ean\" name=\"Product EAN\" basetype=\"text\"/><field reverse=\"false\" skey=\"itemtype\" name=\"itemtype\" basetype=\"unknown\"/><field reverse=\"false\" skey=\"@variant_size\" name=\"variant_size\" basetype=\"asset\"/><field reverse=\"false\" skey=\"@variant_style\" name=\"variant_style\" basetype=\"asset\"/></display-fields>\n\t<attribute-types>\n\t\t<attribute-type name='secondid' basetype='text'>secondid</attribute-type>\n\t\t<attribute-type name='@name' basetype='asset'>name</attribute-type>\n\t\t<attribute-type name='size' basetype='set'>Size</attribute-type>\n\t\t<attribute-type name='style' basetype='set'>Style</attribute-type>\n\t\t<attribute-type name='@v_description' basetype='asset'>v_description</attribute-type>\n\t\t<attribute-type name='@v_name' basetype='asset'>v_name</attribute-type>\n\t\t<attribute-type name='@v_summary' basetype='asset'>v_summary</attribute-type>\n\t\t<attribute-type name='categories' basetype='cat'>Categories</attribute-type>\n\t\t<attribute-type name='code' basetype='unknown'>code</attribute-type>\n\t\t<attribute-type name='ean' basetype='text'>Product EAN</attribute-type>\n\t\t<attribute-type name='itemtype' basetype='unknown'>itemtype</attribute-type>\n\t\t<attribute-type name='@variant_size' basetype='asset'>variant_size</attribute-type>\n\t\t<attribute-type name='@variant_style' basetype='asset'>variant_style</attribute-type>\n\t</attribute-types>\n</universe></universes><footer>\n\t<process-time unit=\"s\">0.006</process-time>\n\t<log-args>id=unknown&amp;proctime=0.006&amp;view=lister&amp;items=100124,100191,100378,100402,100744,100746,100988,101580,108295,110839,130663,132871,92961,94172,94374,94382,97199,97252,102153,102277&amp;themes=&amp;location=%2f%2fcatalog01%2fen_GB&amp;listerstartindex=0&amp;listernrofitems=233&amp;viewsize=20&amp;sortby=&amp;searchpasses=&amp;itemsinselection=233&amp;usertype=unknown&amp;qid=1250&amp;querystring=</log-args>\n</footer>\n</page></soapenv:Body></soapenv:Envelope>"));
	}

	@Test
	public void testRetry()
	{


		final DefaultFhQueryService queryService = new DefaultFhQueryService();
		queryService.setMaxRetries(3);
		queryService.setFasWebService(getFasWebservice());

		final Query query = new Query("fh_location=//catalog01/en_GB");

		setNegativeAnswer(client);
		setNegativeAnswer(client);
		setNegativeAnswer(client);
		setPositiveAnswer(client);


		final Page page = queryService.execute(query.toString());


		// Print breadcrumbs of selected universe
		for (final Universe u : page.getUniverses().getUniverse())
		{
			if (UniverseType.SELECTED.equals(u.getType()))
			{
				final Breadcrumbs breadcrumbs = u.getBreadcrumbs();
				final int nrOfItemsInSelection = breadcrumbs.getNrOfItemsInSelection();
				System.out.println("Items in selection: " + nrOfItemsInSelection);

				// There is only one selected universe in a response, so we can break.
				break;
			}
		}
	}

	@Test(expected = WebServiceException.class)
	public void testMaxRetry() throws WebServiceException
	{
		final DefaultFhQueryService queryService = new DefaultFhQueryService();
		queryService.setMaxRetries(3);
		queryService.setFasWebService(getFasWebservice());

		final Query query = new Query("fh_location=//catalog01/en_GB");

		setNegativeAnswer(client);
		setNegativeAnswer(client);
		setNegativeAnswer(client);
		setNegativeAnswer(client);
		setPositiveAnswer(client);


		queryService.execute(query.toString());


	}

}
